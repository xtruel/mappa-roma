<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Mappa Roma - 70 Best Places</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS tuo -->
  <link rel="stylesheet" href="style.css">

  <!-- CSS Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
</head>
<body>
  <div id="sidebar">
    <div class="sidebar-header">
      <h1 id="site-title">Mappa Roma</h1>
      <p id="subtitle">Discover the Eternal City</p>
      <div class="language-switcher">
        <button id="lang-en" class="lang-btn active" data-lang="en">EN</button>
        <button id="lang-it" class="lang-btn" data-lang="it">IT</button>
      </div>
      
      <!-- Roma Matches Button -->
      <div class="roma-matches-section">
        <button id="roma-matches-btn" class="roma-btn">
          <span class="roma-icon">‚öΩ</span>
          <span class="roma-text">Partite Roma</span>
        </button>
      </div>
    </div>
    
    <!-- Map Provider Toggle -->
    <div class="map-toggle">
      <button id="mapbox-btn" class="toggle-btn active">Mapbox</button>
      <button id="google-btn" class="toggle-btn">Google Maps</button>
    </div>
    
    <!-- Category Filter -->
    <div class="category-filter">
      <h3>Categories</h3>
      <select id="category-select">
        <option value="all">All Places (70)</option>
        <option value="Ancient Sites">Ancient Sites</option>
        <option value="Religious Sites">Religious Sites</option>
        <option value="Museums">Museums</option>
        <option value="Fountains">Fountains</option>
        <option value="Squares">Squares</option>
        <option value="Parks">Parks</option>
        <option value="Neighborhoods">Neighborhoods</option>
        <option value="Hidden Gems">Hidden Gems</option>
        <option value="Monuments">Monuments</option>
        <option value="Bridges">Bridges</option>
      </select>
    </div>
    
    <!-- Places Counter -->
    <div class="places-counter">
      <span id="places-count">70 places shown</span>
    </div>
  </div>

  <!-- Roma Matches Modal -->
  <div id="roma-matches-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üèõÔ∏è AS Roma - Prossime Partite</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div id="matches-loading" class="loading">Caricamento partite...</div>
        <div id="matches-container" class="matches-list"></div>
        <div id="matches-error" class="error-message" style="display: none;">Errore nel caricamento delle partite. Riprova pi√π tardi.</div>
      </div>
    </div>
  </div>
  
  <div id="mapbox-container" class="map-container active">
    <div id="mapbox-map"></div>
  </div>
  
  <div id="google-container" class="map-container">
    <div id="google-map"></div>
  </div>

  <!-- JS Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  
  <!-- Google Maps API -->
  <!-- Google Maps API - Replace YOUR_GOOGLE_MAPS_API_KEY with your actual API key -->
  <!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initGoogleMap"></script> -->

  <!-- Rome Places Data -->
  <script src="rome-places-data.js"></script>
  <script src="language-data.js"></script>
  
  <!-- File con i luoghi (legacy) -->
  <script src="luoghi.js"></script>

  <!-- Main Application Script -->
  <script>
    let currentLanguage = 'en';
    let mapboxMap, googleMap;
    let currentMapProvider = 'mapbox';
    let mapboxMarkers = [];
    let googleMarkers = [];
    let filteredPlaces = [];
    
    // Language switching functionality
    function switchLanguage(lang) {
      currentLanguage = lang;
      updateUILanguage();
      loadPlaces();
      
      // Update active language button
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`lang-${lang}`).classList.add('active');
    }
    
    function updateUILanguage() {
      const texts = languageData[currentLanguage];
      
      // Update page title
      document.title = texts.pageTitle;
      
      // Update site title and subtitle
      document.getElementById('site-title').textContent = texts.siteTitle;
      document.getElementById('subtitle').textContent = texts.subtitle;
      
      // Update category filter
       const categorySelect = document.getElementById('category-select');
       categorySelect.innerHTML = `
         <option value="all">${texts.categories.all}</option>
         <option value="Ancient Sites">${texts.categories.ancientSites}</option>
         <option value="Vatican & Religious">${texts.categories.vaticanReligious}</option>
         <option value="Fountains & Squares">${texts.categories.fountainsSquares}</option>
         <option value="Museums & Galleries">${texts.categories.museumsGalleries}</option>
         <option value="Parks & Gardens">${texts.categories.parksGardens}</option>
         <option value="Neighborhoods">${texts.categories.neighborhoods}</option>
         <option value="Hidden Gems">${texts.categories.hiddenGems}</option>
       `;
      
      // Update places counter
      updatePlacesCounter();
    }
    
    function updatePlacesCounter() {
      const count = filteredPlaces.length;
      const texts = languageData[currentLanguage];
      document.getElementById('places-count').textContent = 
        `${count} ${count === 1 ? texts.placesCounter.singular : texts.placesCounter.plural}`;
    }
    
    function getLocalizedText(textObj) {
      return typeof textObj === 'object' ? textObj[currentLanguage] : textObj;
    }
    
    // Initialize application
    window.onload = function() {
      initMapbox();
      initUI();
      loadPlaces();
      updateUILanguage(); // Initialize UI with default language
    };
    
    // Initialize Mapbox
    function initMapbox() {
      mapboxgl.accessToken = "pk.eyJ1IjoiZnVyaWVyb21hbmUiLCJhIjoiY21lZXBpZ2N5MGY2dzJtczlicTdieDZraiJ9.JVaKNpAZCi32InzFXzOSdw";
      
      mapboxMap = new mapboxgl.Map({
        container: "mapbox-map",
        style: "mapbox://styles/mapbox/streets-v11",
        center: [12.4964, 41.9028],
        zoom: 11
      });
      
      mapboxMap.addControl(new mapboxgl.NavigationControl());
    }
    
    // Initialize Google Maps (called by Google Maps API)
    window.initGoogleMap = function() {
      if (typeof google !== 'undefined' && google.maps) {
        googleMap = new google.maps.Map(document.getElementById('google-map'), {
          center: { lat: 41.9028, lng: 12.4964 },
          zoom: 11,
          mapTypeId: 'roadmap'
        });
        // Enable Google Maps button
        document.getElementById('google-btn').disabled = false;
        document.getElementById('google-btn').style.opacity = '1';
      }
    }
    
    // Initialize UI controls
    function initUI() {
      // Check if Google Maps is available
      if (typeof google === 'undefined' || !google.maps) {
        // Disable Google Maps button if API is not loaded
        const googleBtn = document.getElementById('google-btn');
        googleBtn.disabled = true;
        googleBtn.style.opacity = '0.5';
        googleBtn.title = 'Google Maps API key required';
      }
      
      // Map toggle buttons
      document.getElementById('mapbox-btn').addEventListener('click', () => switchMap('mapbox'));
      document.getElementById('google-btn').addEventListener('click', () => {
        if (typeof google !== 'undefined' && google.maps) {
          switchMap('google');
        } else {
          alert('Google Maps API key is required. Please add your API key to enable Google Maps.');
        }
      });
      
      // Category filter
      document.getElementById('category-select').addEventListener('change', filterPlaces);
      
      // Language switcher event listeners
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const lang = this.getAttribute('data-lang');
          switchLanguage(lang);
        });
      });
      
      // Roma matches button
      document.getElementById('roma-matches-btn').addEventListener('click', openRomaMatchesModal);
      
      // Modal close functionality
      document.querySelector('.close-modal').addEventListener('click', closeRomaMatchesModal);
      window.addEventListener('click', (event) => {
        const modal = document.getElementById('roma-matches-modal');
        if (event.target === modal) {
          closeRomaMatchesModal();
        }
      });
      
      // Roma matches modal event listeners
      document.getElementById('roma-matches-btn').addEventListener('click', openRomaMatchesModal);
      document.querySelector('.close').addEventListener('click', closeRomaMatchesModal);
      
      // Close modal when clicking outside of it
      window.addEventListener('click', (event) => {
        const modal = document.getElementById('roma-matches-modal');
        if (event.target === modal) {
          closeRomaMatchesModal();
        }
      });
    }
    
    // Switch between map providers
    function switchMap(provider) {
      currentMapProvider = provider;
      
      // Update button states
      document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(provider + '-btn').classList.add('active');
      
      // Update map container visibility
      document.querySelectorAll('.map-container').forEach(container => container.classList.remove('active'));
      document.getElementById(provider + '-container').classList.add('active');
      
      // Reload markers for current provider
      loadPlaces();
    }
    
    // Load and display places
    function loadPlaces() {
      if (!window.romePlaces) return;
      
      // Clear existing markers
      clearMarkers();
      
      // Get filtered places
      const selectedCategory = document.getElementById('category-select').value;
      filteredPlaces = selectedCategory === 'all' 
        ? window.romePlaces 
        : window.romePlaces.filter(place => place.category === selectedCategory);
      
      // Update counter
      updatePlacesCounter();
      
      // Add markers based on current provider
      if (currentMapProvider === 'mapbox' && mapboxMap) {
        addMapboxMarkers();
      } else if (currentMapProvider === 'google' && googleMap) {
        addGoogleMarkers();
      }
    }
    
    // Add Mapbox markers
    function addMapboxMarkers() {
      filteredPlaces.forEach(place => {
        const name = getLocalizedText(place.name);
        const description = getLocalizedText(place.description);
        
        const marker = new mapboxgl.Marker({ color: getCategoryColor(place.category) })
          .setLngLat([place.lng, place.lat])
          .setPopup(new mapboxgl.Popup().setHTML(
            `<div class="popup-content">
              <h3>${name}</h3>
              <p><strong>Category:</strong> ${place.category}</p>
              <p>${description}</p>
            </div>`
          ))
          .addTo(mapboxMap);
        
        mapboxMarkers.push(marker);
      });
    }
    
    // Add Google Maps markers
    function addGoogleMarkers() {
      filteredPlaces.forEach(place => {
        const name = getLocalizedText(place.name);
        const description = getLocalizedText(place.description);
        
        const marker = new google.maps.Marker({
          position: { lat: place.lat, lng: place.lng },
          map: googleMap,
          title: name,
          icon: {
            url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(
              `<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <circle cx="10" cy="10" r="8" fill="${getCategoryColor(place.category)}" stroke="white" stroke-width="2"/>
              </svg>`
            )}`,
            scaledSize: new google.maps.Size(20, 20)
          }
        });
        
        const infoWindow = new google.maps.InfoWindow({
          content: `<div class="popup-content">
            <h3>${name}</h3>
            <p><strong>Category:</strong> ${place.category}</p>
            <p>${description}</p>
          </div>`
        });
        
        marker.addListener('click', () => {
          infoWindow.open(googleMap, marker);
        });
        
        googleMarkers.push(marker);
      });
    }
    
    // Clear all markers
    function clearMarkers() {
      mapboxMarkers.forEach(marker => marker.remove());
      mapboxMarkers = [];
      
      googleMarkers.forEach(marker => marker.setMap(null));
      googleMarkers = [];
    }
    
    // Filter places by category
    function filterPlaces() {
      loadPlaces();
    }
    
    // Get color for category
    function getCategoryColor(category) {
      const colors = {
        'Ancient Sites': '#8B4513',
        'Religious Sites': '#4169E1',
        'Museums': '#9932CC',
        'Fountains': '#00CED1',
        'Squares': '#FF6347',
        'Parks': '#32CD32',
        'Neighborhoods': '#FF8C00',
        'Hidden Gems': '#DC143C',
        'Monuments': '#2F4F4F',
        'Bridges': '#708090'
      };
      return colors[category] || '#666666';
    }
    
    // Roma Matches Modal Functions
    function openRomaMatchesModal() {
      const modal = document.getElementById('roma-matches-modal');
      modal.style.display = 'block';
      loadRomaMatches();
    }
    
    function closeRomaMatchesModal() {
      const modal = document.getElementById('roma-matches-modal');
      modal.style.display = 'none';
    }
    
    async function loadRomaMatches() {
      const loadingEl = document.getElementById('matches-loading');
      const containerEl = document.getElementById('matches-container');
      const errorEl = document.getElementById('matches-error');
      
      // Show loading, hide others
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      errorEl.style.display = 'none';
      
      try {
        // Using a free football API (API-Football via RapidAPI)
        // Note: This requires a free API key from RapidAPI
        const response = await fetch('https://api-football-v1.p.rapidapi.com/v3/fixtures?team=497&next=5', {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': 'YOUR_RAPIDAPI_KEY', // User needs to replace this
            'X-RapidAPI-Host': 'api-football-v1.p.rapidapi.com'
          }
        });
        
        if (!response.ok) {
          throw new Error('API request failed');
        }
        
        const data = await response.json();
        displayMatches(data.response || []);
        
      } catch (error) {
        console.error('Error loading Roma matches:', error);
        // Show mock data as fallback
        displayMockMatches();
      }
    }
    
    function displayMatches(matches) {
      const containerEl = document.getElementById('matches-container');
      const loadingEl = document.getElementById('matches-loading');
      
      loadingEl.style.display = 'none';
      containerEl.style.display = 'block';
      
      if (matches.length === 0) {
        containerEl.innerHTML = '<p class="no-matches">Nessuna partita programmata al momento.</p>';
        return;
      }
      
      const matchesHTML = matches.map(match => {
        const date = new Date(match.fixture.date);
        const formattedDate = date.toLocaleDateString('it-IT', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const formattedTime = date.toLocaleTimeString('it-IT', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        return `
          <div class="match-item">
            <div class="match-date">
              <span class="date">${formattedDate}</span>
              <span class="time">${formattedTime}</span>
            </div>
            <div class="match-teams">
              <div class="team home">
                <img src="${match.teams.home.logo}" alt="${match.teams.home.name}" class="team-logo">
                <span class="team-name">${match.teams.home.name}</span>
              </div>
              <div class="vs">VS</div>
              <div class="team away">
                <img src="${match.teams.away.logo}" alt="${match.teams.away.name}" class="team-logo">
                <span class="team-name">${match.teams.away.name}</span>
              </div>
            </div>
            <div class="match-venue">
              <span class="venue">üìç ${match.fixture.venue.name}</span>
              <span class="competition">${match.league.name}</span>
            </div>
          </div>
        `;
      }).join('');
      
      containerEl.innerHTML = matchesHTML;
    }
    
    function displayMockMatches() {
      const containerEl = document.getElementById('matches-container');
      const loadingEl = document.getElementById('matches-loading');
      
      loadingEl.style.display = 'none';
      containerEl.style.display = 'block';
      
      // Mock data for demonstration
      const mockMatches = [
        {
          date: 'Domenica, 26 Gennaio 2025',
          time: '15:00',
          homeTeam: 'AS Roma',
          awayTeam: 'Napoli',
          venue: 'Stadio Olimpico',
          competition: 'Serie A'
        },
        {
          date: 'Gioved√¨, 30 Gennaio 2025',
          time: '21:00',
          homeTeam: 'Eintracht Frankfurt',
          awayTeam: 'AS Roma',
          venue: 'Deutsche Bank Park',
          competition: 'Europa League'
        },
        {
          date: 'Domenica, 2 Febbraio 2025',
          time: '18:00',
          homeTeam: 'AS Roma',
          awayTeam: 'Genoa',
          venue: 'Stadio Olimpico',
          competition: 'Serie A'
        }
      ];
      
      const matchesHTML = mockMatches.map(match => `
        <div class="match-item">
          <div class="match-date">
            <span class="date">${match.date}</span>
            <span class="time">${match.time}</span>
          </div>
          <div class="match-teams">
            <div class="team home">
              <span class="team-name">${match.homeTeam}</span>
            </div>
            <div class="vs">VS</div>
            <div class="team away">
              <span class="team-name">${match.awayTeam}</span>
            </div>
          </div>
          <div class="match-venue">
            <span class="venue">üìç ${match.venue}</span>
            <span class="competition">${match.competition}</span>
          </div>
        </div>
      `).join('');
      
      containerEl.innerHTML = matchesHTML + '<p class="api-note">üí° <em>Dati di esempio - Configura API-Football per dati reali</em></p>';
    }
    
    // Legacy support for old luoghi.js
    if (window.PLACES) {
      window.PLACES.forEach(place => {
        if (mapboxMap) {
          new mapboxgl.Marker()
            .setLngLat(place.coords)
            .setPopup(new mapboxgl.Popup().setHTML(`<b>${place.name}</b><br>${place.desc}`))
            .addTo(mapboxMap);
        }
      });
    }
  </script>
</body>
</html>
